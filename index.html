<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FSTV 2.1 | World Streaming</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- HLS.js -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDKs (Stable v10.13.1) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        // Expose to window for React
        window.firebaseModules = { 
            initializeApp, getAuth, signInWithPopup, GoogleAuthProvider, 
            signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, 
            onAuthStateChanged,
            getFirestore, doc, setDoc, getDoc, onSnapshot 
        };
    </script>

    <style>
        /* Modern Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

        body {
            background: #09090b;
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        .glass {
            background: rgba(18, 18, 23, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.08);
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
        }
        
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- FIREBASE SETUP (YOUR KEYS ARE HERE) ---
        const initFirebase = async () => {
            if (!window.firebaseModules) return null;
            const { initializeApp, getAuth, getFirestore } = window.firebaseModules;
            
            // YOUR CONFIGURATION
            const config = {
                apiKey: "AIzaSyBQGhUXBhgzga9bZ6dYtOJWQU8F-TkT05A",
                authDomain: "fstv-a53f0.firebaseapp.com",
                projectId: "fstv-a53f0",
                storageBucket: "fstv-a53f0.firebasestorage.app",
                messagingSenderId: "304492300265",
                appId: "1:304492300265:web:114cb6a6800bcbb1fa6d78",
                measurementId: "G-1W9GKMVCWM"
            };

            try {
                const app = initializeApp(config);
                const auth = getAuth(app);
                const db = getFirestore(app);
                const appId = "fstv-a53f0"; 
                return { auth, db, appId };
            } catch (e) {
                console.error("Firebase Init Failed:", e);
                return null;
            }
        };

        // --- COMPONENTS ---

        // 1. Auth Modal
        const AuthModal = ({ onClose, firebase, onLogin }) => {
            const [isSignUp, setIsSignUp] = useState(false);
            const [email, setEmail] = useState("");
            const [password, setPassword] = useState("");
            const [error, setError] = useState("");

            const handleGoogle = async () => {
                const { signInWithPopup, GoogleAuthProvider } = window.firebaseModules;
                const provider = new GoogleAuthProvider();
                try {
                    const result = await signInWithPopup(firebase.auth, provider);
                    onLogin(result.user);
                    onClose();
                } catch (err) {
                    console.error(err);
                    setError("Google Sign-In failed. Check console or use Email.");
                }
            };

            const handleEmail = async (e) => {
                e.preventDefault();
                setError("");
                const { signInWithEmailAndPassword, createUserWithEmailAndPassword } = window.firebaseModules;
                try {
                    let cred;
                    if (isSignUp) {
                        cred = await createUserWithEmailAndPassword(firebase.auth, email, password);
                    } else {
                        cred = await signInWithEmailAndPassword(firebase.auth, email, password);
                    }
                    onLogin(cred.user);
                    onClose();
                } catch (err) {
                    setError(err.message.replace("Firebase: ", ""));
                }
            };

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm">
                    <div className="bg-[#18181b] p-8 rounded-2xl w-full max-w-md border border-white/10 shadow-2xl relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-white"><i data-lucide="x"></i></button>
                        <h2 className="text-2xl font-bold mb-6 text-center">{isSignUp ? "Create Account" : "Welcome Back"}</h2>
                        <button onClick={handleGoogle} className="w-full bg-white text-black font-medium py-2.5 rounded-lg flex items-center justify-center gap-2 mb-4 hover:bg-gray-200 transition">
                            Continue with Google
                        </button>
                        <div className="flex items-center gap-4 my-4"><div className="h-px bg-white/10 flex-1"></div><span className="text-xs text-gray-500">OR</span><div className="h-px bg-white/10 flex-1"></div></div>
                        <form onSubmit={handleEmail} className="space-y-4">
                            {error && <div className="p-3 bg-red-500/20 text-red-200 text-xs rounded border border-red-500/30">{error}</div>}
                            <input type="email" placeholder="Email address" required value={email} onChange={e=>setEmail(e.target.value)} className="w-full bg-black/20 border border-white/10 rounded-lg p-3 text-sm focus:border-blue-500 outline-none" />
                            <input type="password" placeholder="Password" required value={password} onChange={e=>setPassword(e.target.value)} className="w-full bg-black/20 border border-white/10 rounded-lg p-3 text-sm focus:border-blue-500 outline-none" />
                            <button type="submit" className="w-full bg-blue-600 hover:bg-blue-500 text-white font-medium py-2.5 rounded-lg transition">{isSignUp ? "Sign Up" : "Log In"}</button>
                        </form>
                        <p className="mt-4 text-center text-xs text-gray-400">{isSignUp ? "Already have an account?" : "Don't have an account?"} <button onClick={() => setIsSignUp(!isSignUp)} className="text-blue-400 ml-1 hover:underline">{isSignUp ? "Log In" : "Sign Up"}</button></p>
                    </div>
                </div>
            );
        };

        // 2. Video Player
        const VideoPlayer = ({ stream, toggleFav, isFav }) => {
            const videoRef = useRef(null);
            const hlsRef = useRef(null);

            useEffect(() => {
                if (!stream) return;
                const video = videoRef.current;
                if (Hls.isSupported()) {
                    if (hlsRef.current) hlsRef.current.destroy();
                    const hls = new Hls();
                    hlsRef.current = hls;
                    hls.loadSource(stream.url);
                    hls.attachMedia(video);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => video.play().catch(() => {}));
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    video.src = stream.url;
                    video.addEventListener('loadedmetadata', () => video.play());
                }
                return () => { if (hlsRef.current) hlsRef.current.destroy(); };
            }, [stream]);

            return (
                <div className="w-full animate-fade-in">
                    <div className="relative aspect-video bg-black rounded-xl overflow-hidden shadow-2xl border border-white/10 group">
                        <video ref={videoRef} className="w-full h-full" controls autoPlay />
                    </div>
                    <div className="mt-4 flex justify-between items-start">
                        <div>
                            <h1 className="text-xl md:text-2xl font-bold text-white mb-1">{stream.name}</h1>
                            <div className="flex gap-2 text-sm text-gray-400 items-center">
                                <span className="bg-white/10 px-2 py-0.5 rounded text-xs">{stream.group || 'Live TV'}</span>
                                {stream.language && <span className="uppercase text-xs border border-white/10 px-1 rounded">{stream.language[0]}</span>}
                            </div>
                        </div>
                        <button onClick={() => toggleFav(stream)} className={`p-2 rounded-full border transition ${isFav ? 'bg-red-500/20 border-red-500 text-red-500' : 'border-white/10 text-gray-400 hover:text-white'}`}>
                            <i data-lucide="heart" className={`w-5 h-5 ${isFav ? 'fill-current' : ''}`}></i>
                        </button>
                    </div>
                    <hr className="border-white/10 my-4" />
                </div>
            );
        };

        // 3. Grid Card
        const ChannelCard = ({ channel, onClick, isFav }) => (
            <div onClick={() => onClick(channel)} className="group relative flex flex-col p-3 rounded-xl glass hover:bg-white/5 transition cursor-pointer border border-transparent hover:border-blue-500/30 card-hover">
                <div className="relative aspect-video bg-black/40 rounded-lg overflow-hidden mb-2 flex items-center justify-center p-2">
                    {channel.logo ? <img src={channel.logo} className="w-full h-full object-contain" onError={(e) => e.target.style.display='none'} /> : <span className="text-xl font-bold text-white/20">FSTV</span>}
                    <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity">
                        <i data-lucide="play" className="fill-white text-white w-8 h-8"></i>
                    </div>
                    {isFav && <div className="absolute top-1 right-1 text-red-500"><i data-lucide="heart" className="w-4 h-4 fill-current"></i></div>}
                </div>
                <h3 className="text-sm font-medium truncate text-gray-200 group-hover:text-blue-400">{channel.name}</h3>
                <p className="text-xs text-gray-500 truncate mt-1">{channel.group}</p>
            </div>
        );

        // 4. Main App
        const App = () => {
            // Data
            const [countries, setCountries] = useState([]);
            const [languages, setLanguages] = useState([]);
            const [globalCategories, setGlobalCategories] = useState([]); // For Explore
            const [channels, setChannels] = useState([]);
            const [user, setUser] = useState(null);
            
            // View & Filters
            const [view, setView] = useState('home'); 
            const [selectedContext, setSelectedContext] = useState({ type: 'category', value: 'All' }); 
            const [activeCategory, setActiveCategory] = useState('All'); // The Genre Filter
            
            const [currentStream, setCurrentStream] = useState(null);
            const [isSidebarOpen, setSidebarOpen] = useState(true);
            const [search, setSearch] = useState("");
            const [showLogin, setShowLogin] = useState(false);
            const [loading, setLoading] = useState(false);
            const [firebase, setFirebase] = useState(null);

            // Persistence
            const [pins, setPins] = useState([
                { type: 'country', code: 'ca', name: 'Canada' },
                { type: 'country', code: 'in', name: 'India' }
            ]);
            const [favorites, setFavorites] = useState([]);

            // Init
            useEffect(() => {
                let unsubscribeAuth = () => {};

                const boot = async () => {
                    try {
                        const [cRes, lRes, catRes] = await Promise.all([
                            fetch('https://iptv-org.github.io/api/countries.json'),
                            fetch('https://iptv-org.github.io/api/languages.json'),
                            fetch('https://iptv-org.github.io/api/categories.json')
                        ]);
                        setCountries(await cRes.json());
                        setLanguages(await lRes.json());
                        setGlobalCategories(await catRes.json());
                    } catch (e) { console.error("API Error", e); }

                    // Geo
                    try {
                        const geoRes = await fetch('https://ipapi.co/json/');
                        const geo = await geoRes.json();
                        if (geo.country_code) {
                            const userCountry = geo.country_code.toLowerCase();
                            setPins(prev => {
                                if(prev.find(p => p.code === userCountry)) return prev;
                                return [{ type: 'country', code: userCountry, name: geo.country_name }, ...prev];
                            });
                            loadPlaylist('country', userCountry, geo.country_name);
                        } else {
                            loadPlaylist('country', 'ca', 'Canada');
                        }
                    } catch (e) {
                        loadPlaylist('country', 'ca', 'Canada');
                    }

                    // Firebase
                    try {
                        const fb = await initFirebase();
                        setFirebase(fb);
                        
                        if (fb && fb.auth && window.firebaseModules) {
                            const { onAuthStateChanged, doc, onSnapshot } = window.firebaseModules;
                            
                            // Check if function exists before calling
                            if (typeof onAuthStateChanged === 'function') {
                                unsubscribeAuth = onAuthStateChanged(fb.auth, (u) => {
                                    setUser(u);
                                    if (u && fb.db) {
                                        // Subscribe to User Data
                                        onSnapshot(doc(fb.db, 'artifacts', fb.appId, 'users', u.uid, 'profile'), (snap) => {
                                            if (snap.exists()) {
                                                const data = snap.data();
                                                if (data.favorites) setFavorites(data.favorites);
                                                if (data.pins) setPins(data.pins);
                                            }
                                        });
                                    }
                                });
                            }
                        }
                    } catch (e) {
                        console.log("Firebase Connection Skipped/Failed:", e);
                    }
                };
                boot();
                return () => unsubscribeAuth();
            }, []);

            // Logic
            const loadPlaylist = async (type, code, name) => {
                setLoading(true);
                setChannels([]);
                setSelectedContext({ type, value: code, name });
                setView('home');
                setActiveCategory('All'); 
                
                let url = '';
                if (type === 'country') url = `https://iptv-org.github.io/iptv/countries/${code}.m3u`;
                else if (type === 'lang') url = `https://iptv-org.github.io/iptv/languages/${code}.m3u`;
                else if (type === 'category') url = `https://iptv-org.github.io/iptv/categories/${code}.m3u`;
                else if (type === 'fav') { setLoading(false); return; }

                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error("List not found");
                    const text = await res.text();
                    const parsed = [];
                    const lines = text.split('\n');
                    let curr = {};
                    lines.forEach(line => {
                        line = line.trim();
                        if (line.startsWith('#EXTINF:')) {
                            const logo = line.match(/tvg-logo="(.*?)"/)?.[1];
                            const group = line.match(/group-title="(.*?)"/)?.[1];
                            const name = line.split(',').pop();
                            curr = { name, logo, group: group || 'General', id: Math.random().toString(36) };
                        } else if (line.startsWith('http')) {
                            if (curr.name) { curr.url = line; parsed.push(curr); curr = {}; }
                        }
                    });
                    setChannels(parsed);
                } catch (e) {
                    console.error(e);
                } finally {
                    setLoading(false);
                }
            };

            const togglePin = async (item) => {
                const exists = pins.find(p => p.code === item.code && p.type === item.type);
                let newPins;
                if (exists) newPins = pins.filter(p => p.code !== item.code || p.type !== item.type);
                else newPins = [...pins, item];
                setPins(newPins);
                if (user && firebase) {
                    const { doc, setDoc } = window.firebaseModules;
                    await setDoc(doc(firebase.db, 'artifacts', firebase.appId, 'users', user.uid, 'profile'), { pins: newPins }, { merge: true });
                }
            };

            const toggleFav = async (channel) => {
                const exists = favorites.find(f => f.url === channel.url);
                let newFavs;
                if (exists) newFavs = favorites.filter(f => f.url !== channel.url);
                else newFavs = [...favorites, channel];
                setFavorites(newFavs);
                if (user && firebase) {
                    const { doc, setDoc } = window.firebaseModules;
                    await setDoc(doc(firebase.db, 'artifacts', firebase.appId, 'users', user.uid, 'profile'), { favorites: newFavs }, { merge: true });
                }
            };

            const playChannel = (channel) => {
                setCurrentStream(channel);
                setView('watch');
            };

            // Dynamic Categories derived from current channel list
            const currentCategories = useMemo(() => {
                const cats = new Set(channels.map(c => c.group));
                return ['All', ...Array.from(cats).sort().filter(Boolean)];
            }, [channels]);

            const displayedChannels = useMemo(() => {
                let data = selectedContext.type === 'fav' ? favorites : channels;
                if (activeCategory !== 'All' && selectedContext.type !== 'fav') {
                    data = data.filter(c => c.group === activeCategory);
                }
                if (search) data = data.filter(c => c.name.toLowerCase().includes(search.toLowerCase()));
                return data;
            }, [channels, favorites, selectedContext, activeCategory, search]);

            // --- RENDERERS ---

            const renderSidebar = () => (
                <div className={`fixed inset-y-0 left-0 bg-[#0f0f13] border-r border-white/5 w-64 transform transition-transform z-40 flex flex-col ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0`}>
                    <div className="p-6">
                        <h1 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-indigo-500 cursor-pointer" onClick={()=>loadPlaylist('country', 'ca', 'Canada')}>FSTV 2.1</h1>
                    </div>

                    <div className="flex-1 overflow-y-auto px-4 space-y-6">
                        {/* Pinned */}
                        <div>
                            <h3 className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 px-3">Pinned</h3>
                            <div className="space-y-1">
                                {pins.map((pin, i) => (
                                    <button key={i} onClick={()=>loadPlaylist(pin.type, pin.code, pin.name)} className={`w-full flex items-center justify-between px-3 py-2 rounded-lg text-sm transition ${selectedContext.value === pin.code ? 'bg-white/10 text-white' : 'text-gray-400 hover:text-white hover:bg-white/5'}`}>
                                        <div className="flex items-center gap-2 truncate">
                                            {pin.type === 'country' ? <span className="text-lg">ðŸ‡¨ðŸ‡¦</span> : pin.type === 'lang' ? <span className="text-xs border px-1 rounded">LN</span> : <i data-lucide="tag" className="w-3 h-3"></i>}
                                            <span className="truncate">{pin.name}</span>
                                        </div>
                                        {selectedContext.value === pin.code && <div className="w-1.5 h-1.5 rounded-full bg-blue-500"></div>}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="h-px bg-white/5"></div>

                        {/* Actions */}
                         <div className="space-y-1">
                            <button onClick={()=>setView('explore')} className={`w-full flex items-center gap-3 px-3 py-2 rounded-lg transition ${view === 'explore' ? 'bg-blue-600/20 text-blue-400' : 'text-gray-400 hover:text-white hover:bg-white/5'}`}>
                                <i data-lucide="globe" className="w-5 h-5"></i> Explore World
                            </button>
                            <button onClick={()=>{setSelectedContext({type:'fav', value:'fav', name:'Favorites'}); setView('home');}} className={`w-full flex items-center gap-3 px-3 py-2 rounded-lg transition ${selectedContext.type === 'fav' ? 'bg-blue-600/20 text-blue-400' : 'text-gray-400 hover:text-white hover:bg-white/5'}`}>
                                <i data-lucide="heart" className="w-5 h-5"></i> Favorites
                            </button>
                        </div>

                        {/* Dynamic Genres (Only shows if channels are loaded) */}
                        {channels.length > 0 && selectedContext.type !== 'fav' && (
                            <div>
                                <h3 className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 px-3 mt-4">Filter: {selectedContext.name}</h3>
                                <div className="space-y-1 max-h-60 overflow-y-auto custom-scrollbar">
                                    {currentCategories.map((cat, i) => (
                                        <button key={i} onClick={()=>setActiveCategory(cat)} className={`w-full text-left px-3 py-1.5 rounded-lg text-sm transition flex justify-between ${activeCategory === cat ? 'bg-blue-600/20 text-blue-400' : 'text-gray-400 hover:text-white hover:bg-white/5'}`}>
                                            <span className="truncate">{cat}</span>
                                            {activeCategory === cat && <i data-lucide="check" className="w-3 h-3"></i>}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Profile Footer */}
                    <div className="p-4 border-t border-white/5">
                        {user ? (
                            <div className="flex items-center gap-3">
                                <div className="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex items-center justify-center font-bold text-xs">{user.email[0].toUpperCase()}</div>
                                <div className="flex-1 min-w-0">
                                    <p className="text-sm font-medium truncate">{user.email.split('@')[0]}</p>
                                    <button onClick={()=>window.firebaseModules.signOut(firebase.auth)} className="text-xs text-red-400 hover:underline">Sign Out</button>
                                </div>
                            </div>
                        ) : (
                            <button onClick={()=>setShowLogin(true)} className="w-full bg-white/10 hover:bg-white/20 py-2 rounded-lg text-sm font-medium transition">
                                Login / Sync
                            </button>
                        )}
                    </div>
                </div>
            );

            const renderExplore = () => (
                <div className="p-6 pb-20 animate-fade-in">
                    <h2 className="text-3xl font-bold mb-2">Explore the World</h2>
                    <p className="text-gray-400 mb-8">Select a country, language, or global category.</p>

                    {/* Global Categories Grid */}
                    <h3 className="text-xl font-bold mb-4 flex items-center gap-2"><i data-lucide="layout-grid" className="w-5 h-5 text-green-400"></i> Global Categories</h3>
                    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 mb-8">
                        {globalCategories.slice(0, 12).map(c => {
                            const isPinned = pins.some(p => p.code === c.id && p.type === 'category');
                            return (
                                <div key={c.id} className="glass p-3 rounded-xl flex items-center justify-between group hover:bg-white/10 transition">
                                    <button onClick={()=>loadPlaylist('category', c.id, c.name)} className="flex items-center gap-3 text-left flex-1 min-w-0">
                                        <i data-lucide="tag" className="w-4 h-4 text-gray-400"></i>
                                        <span className="text-sm font-medium truncate">{c.name}</span>
                                    </button>
                                    <button onClick={()=>togglePin({type:'category', code:c.id, name:c.name})} className={`opacity-0 group-hover:opacity-100 transition ${isPinned ? 'opacity-100 text-blue-400' : 'text-gray-500 hover:text-white'}`}>
                                        <i data-lucide="pin" className="w-4 h-4"></i>
                                    </button>
                                </div>
                            )
                        })}
                    </div>

                    {/* Countries Grid */}
                    <h3 className="text-xl font-bold mb-4 flex items-center gap-2"><i data-lucide="map" className="w-5 h-5 text-blue-400"></i> Countries</h3>
                    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 mb-8">
                        {countries.filter(c => c.name.toLowerCase().includes(search.toLowerCase())).slice(0, 18).map(c => {
                            const isPinned = pins.some(p => p.code === c.code.toLowerCase());
                            return (
                                <div key={c.code} className="glass p-3 rounded-xl flex items-center justify-between group hover:bg-white/10 transition">
                                    <button onClick={()=>loadPlaylist('country', c.code.toLowerCase(), c.name)} className="flex items-center gap-3 text-left flex-1 min-w-0">
                                        <span className="text-2xl">{c.flag}</span>
                                        <span className="text-sm font-medium truncate">{c.name}</span>
                                    </button>
                                    <button onClick={()=>togglePin({type:'country', code:c.code.toLowerCase(), name:c.name})} className={`opacity-0 group-hover:opacity-100 transition ${isPinned ? 'opacity-100 text-blue-400' : 'text-gray-500 hover:text-white'}`}>
                                        <i data-lucide="pin" className="w-4 h-4"></i>
                                    </button>
                                </div>
                            )
                        })}
                    </div>
                </div>
            );

            return (
                <div className="flex h-screen w-full">
                    {renderSidebar()}
                    
                    <div className="flex-1 flex flex-col relative bg-[#09090b]">
                        {/* Header */}
                        <div className="h-16 border-b border-white/5 flex items-center px-6 gap-4 bg-black/20 backdrop-blur z-20">
                            <button onClick={()=>setSidebarOpen(!isSidebarOpen)} className="md:hidden p-2 text-gray-400"><i data-lucide="menu"></i></button>
                            
                            <div className="flex-1 max-w-lg relative">
                                <input type="text" value={search} onChange={e=>setSearch(e.target.value)} placeholder={`Search ${view === 'explore' ? 'Categories...' : selectedContext.name + '...'}`} className="w-full bg-white/5 border border-white/10 rounded-full py-2 pl-10 pr-4 text-sm focus:bg-black focus:border-blue-500 transition outline-none" />
                                <i data-lucide="search" className="absolute left-3.5 top-2.5 w-4 h-4 text-gray-500"></i>
                            </div>

                            <div className="text-xs font-bold px-3 py-1 bg-blue-500/10 text-blue-400 rounded-full border border-blue-500/20 hidden md:block">
                                {selectedContext.name} {activeCategory !== 'All' && ` > ${activeCategory}`}
                            </div>
                        </div>

                        {/* Content */}
                        <div className="flex-1 overflow-y-auto relative scroll-smooth">
                            {view === 'watch' && currentStream ? (
                                <div className="flex flex-col lg:flex-row h-full">
                                    <div className="flex-1 p-6 overflow-y-auto">
                                        <button onClick={()=>setView('home')} className="mb-4 text-sm text-gray-400 hover:text-white flex items-center gap-2"><i data-lucide="arrow-left" className="w-4 h-4"></i> Back to Grid</button>
                                        <VideoPlayer stream={currentStream} toggleFav={toggleFav} isFav={favorites.some(f=>f.url===currentStream.url)} />
                                    </div>
                                    <div className="w-full lg:w-96 border-l border-white/5 bg-[#0c0c0e] p-4 overflow-y-auto">
                                        <h3 className="font-bold mb-4 text-gray-400 text-xs uppercase">Up Next in {activeCategory !== 'All' ? activeCategory : selectedContext.name}</h3>
                                        <div className="space-y-2">
                                            {displayedChannels.filter(c=>c.url!==currentStream.url).slice(0,50).map((c,i) => (
                                                <div key={i} onClick={()=>playChannel(c)} className="flex gap-3 p-2 hover:bg-white/5 rounded cursor-pointer group">
                                                    <div className="w-24 aspect-video bg-black/50 rounded flex items-center justify-center"><img src={c.logo} className="h-full object-contain" onError={e=>e.target.style.display='none'}/></div>
                                                    <div className="flex-1 min-w-0 flex flex-col justify-center">
                                                        <p className="text-sm font-medium truncate group-hover:text-blue-400">{c.name}</p>
                                                        <p className="text-xs text-gray-500">{c.group}</p>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            ) : view === 'explore' ? (
                                renderExplore()
                            ) : (
                                // Home Grid
                                <div className="p-6">
                                    {loading ? (
                                        <div className="text-center py-20 text-gray-500"><div className="animate-spin w-8 h-8 border-t-2 border-blue-500 rounded-full mx-auto mb-4"></div>Fetching Channels...</div>
                                    ) : (
                                        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                                            {displayedChannels.slice(0, 100).map((c, i) => (
                                                <ChannelCard key={i} channel={c} onClick={playChannel} isFav={favorites.some(f=>f.url===c.url)} />
                                            ))}
                                        </div>
                                    )}
                                    {!loading && displayedChannels.length === 0 && <div className="text-center py-20 text-gray-500">No channels found. Try the Explore tab!</div>}
                                </div>
                            )}
                        </div>
                    </div>

                    {showLogin && <AuthModal onClose={()=>setShowLogin(false)} firebase={firebase} onLogin={(u)=>setUser(u)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        
        setTimeout(() => window.lucide && window.lucide.createIcons(), 500);
        setInterval(() => window.lucide && window.lucide.createIcons(), 2000); 
    </script>
</body>
</html>